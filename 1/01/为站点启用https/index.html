<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>
         - my101du Blog
      </title>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    
    <meta name="theme-color" content="#000000" />
    
    <meta http-equiv="window-target" content="_top" />
    
    
    <meta name="description" content="title: 为站点启用HTTPS permalink: make-your-website-https tags:
 HTTPS 运维  " />
    <meta name="generator" content="Hugo 0.70.0 with theme pure" />
    <title> - my101du Blog</title>
    
    
    <link rel="stylesheet" href="https://my101du.github.io/css/style.min.7dc20efbc53647d41aa9ddea0c48e59300223d084e66ea0cbe7c30bd88903acc.css">
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
    <meta property="og:title" content="" />
<meta property="og:description" content="title: 为站点启用HTTPS
permalink: make-your-website-https
tags:

HTTPS
运维

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://my101du.github.io/1/01/%E4%B8%BA%E7%AB%99%E7%82%B9%E5%90%AF%E7%94%A8https/" />

<meta itemprop="name" content="">
<meta itemprop="description" content="title: 为站点启用HTTPS
permalink: make-your-website-https
tags:

HTTPS
运维

">

<meta itemprop="wordCount" content="7876">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="title: 为站点启用HTTPS
permalink: make-your-website-https
tags:

HTTPS
运维

"/>

    <!--[if lte IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
      <![endif]-->

    <!--[if lt IE 9]>
        <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
      <![endif]-->
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/my101du" target="_blank">
            <img class="img-circle img-rotate" src="https://avatars2.githubusercontent.com/u/1332645?s=460&amp;u=dc114d6baad010456a5af87c4cc2df0694ff2b1c&amp;v=4" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">my101du</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Dongguan, China</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="想要查找什么..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts/">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about/">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p>enjoy~</p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <h3 class="widget-title"> 分类</h3>
    <div class="widget-body">
        <ul class="category-list">
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> 标签</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://my101du.github.io/tags/skills/" class="tag-list-link">skills</a><span
                    class="tag-list-count">1</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://my101du.github.io/1/01/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" class="title"></a>
                    </p>
                    <p class="item-date">
                        <time datetime="0001-01-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">0001-01-01</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://my101du.github.io/1/01/bootstrap-%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5%E4%B8%8E%E6%8A%80%E5%B7%A7/" class="title"></a>
                    </p>
                    <p class="item-date">
                        <time datetime="0001-01-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">0001-01-01</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://my101du.github.io/1/01/bootstrap4/" class="title"></a>
                    </p>
                    <p class="item-date">
                        <time datetime="0001-01-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">0001-01-01</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://my101du.github.io/1/01/css-%E5%8A%A8%E7%94%BB/" class="title"></a>
                    </p>
                    <p class="item-date">
                        <time datetime="0001-01-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">0001-01-01</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://my101du.github.io/1/01/css-%E5%8A%A8%E7%94%BB%E5%BA%93-animate.css/" class="title"></a>
                    </p>
                    <p class="item-date">
                        <time datetime="0001-01-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">0001-01-01</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">文章目录</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/1/01/%E4%B8%BA%E7%AB%99%E7%82%B9%E5%90%AF%E7%94%A8https/"
    ></a
  >
</h1>

      <div class="article-meta">
        

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/1/01/%E4%B8%BA%E7%AB%99%E7%82%B9%E5%90%AF%E7%94%A8https/#comments"
            class="article-comment-link">评论</a></span>
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 7876字</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 16分 </span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <p>title: 为站点启用HTTPS
permalink: make-your-website-https
tags:</p>
<ul>
<li>HTTPS</li>
<li>运维</li>
</ul>
<hr>
<h1 id="在线生成免费的证书">在线生成免费的证书</h1>
<p><a href="https://freessl.cn/">https://freessl.cn/</a></p>
<p>例如下载 key manager(<a href="https://keymanager.org/">https://keymanager.org/</a>)辅助 或者直接浏览器生成私钥</p>
<p>添加域名 TXT 记录</p>
<p>添加dns 服务商。  拿到证书后，点“导出”，然后复制 xxx.key  和 xxx.crt (就是pem) 里的内容，粘贴到需要的地方即可</p>
<h1 id="为站点部署-ssl">为站点部署 SSL</h1>
<p>免费的证书认证机构：StartSSL（www.startssl.com）</p>
<p>域名认证（Domain Validation）：认证你的域名所有权和网站，申请验证简单，几分钟即可。
组织机构认证（Organization Validation）：认证的域名和公司信息，需要提交公司资料认证。
扩展认证（Extended Validation，简称EV）：这种证书会在浏览器中出现“很明显”的绿色地址栏，给用户的可信度最高。有安全评估保证。</p>
<p>个人用户申请第一个就可以了，其他的要么会收费。</p>
<h2 id="为域名申请证书">为域名申请证书</h2>
<p>x509证书一般会用到三类文件</p>
<ul>
<li><code>key</code> 是私用密钥，openssl格式，通常是rsa算法。</li>
<li><code>csr</code> 是证书请求文件，用于申请证书。在制作csr文件的时候，必须使用自己的私钥来签署申请，还可以设定一个密钥。</li>
<li><code>crt</code> 是CA认证后的证书文件，签署人用自己的key给你签署的凭证。</li>
</ul>
<p>运行下面的命令，根据提示输入个人信息、公司信息、密码等</p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-nginx-for-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-nginx-for-ubuntu-14-04</a></p>
<p><a href="https://blog.csdn.net/liuchunming033/article/details/48470575">https://blog.csdn.net/liuchunming033/article/details/48470575</a></p>
<p>可以直接用在本地了，但是访问会提示不安全</p>
<pre><code class="language-shell"># 默认需要 pem 密码
openssl req -newkey rsa:2048 -keyout your_site.key -out your_site.csr


# 如果需要的话，在参数列表还可以设置一个 -days 365 过期时间，
openssl req -new -nodes -sha256 -newkey rsa:2048 -keyout myprivate.key -out mydomain.csr
</code></pre>
<p>根据提示，输入国家、省份、城市等。<strong><code>common name</code>里输入域名</strong>，challenge password 可以留空</p>
<p>如果不想以交互式手动输入，可以直接在命令里带参数<code> -subj &quot;/C=GB/ST=London/L=London/O=Global Security/OU=IT Department/CN=example.com&quot;</code></p>
<p>然后提交到证书签名网站/服务</p>
<h2 id="例子以-nginx-服务器需要提交一个申请给-godaddy-签名为例">例子，以 nginx 服务器，需要提交一个申请给 godaddy 签名为例</h2>
<p><a href="https://sg.godaddy.com/zh/help/nginx-csr-3601">https://sg.godaddy.com/zh/help/nginx-csr-3601</a></p>
<pre><code class="language-shell">openssl req -new -newkey rsa:2048 -nodes -keyout 您的域名.key -out 您的域名.csr
</code></pre>
<h1 id="自签名">自签名</h1>
<h2 id="生成服务器端的私钥-key-文件">生成服务器端的私钥 .key 文件</h2>
<pre><code class="language-shell"># 这一步如果要密码，随便输入 1234
openssl genrsa -des3 -out server.key 1024
# 去掉密码， -in -out 处理下
openssl rsa -in server.key -out server.key

# 或者干脆简化成
openssl genrsa -out server.key 1024
</code></pre>
<h2 id="生成服务器端证书签名请求文件-csr">生成服务器端证书签名请求文件 .csr</h2>
<p><code>-key</code>指定刚拿到的私钥</p>
<pre><code class="language-shell">openssl req -new -key server.key -out server.csr
</code></pre>
<p>根据命令行向导来进行信息输入, Common Name 就是域名了，如果需要通配符域名证书，就写  <code>*.sample.org</code></p>
<pre><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) []:CN
State or Province Name (full name) []:GuangDong
Locality Name (eg, city) []:Dongguan
Organization Name (eg, company) []:MicroHard
Organizational Unit Name (eg, section) []:UPO
Common Name (eg, fully qualified host name) []:*.sample.com
Email Address []:test@microhard.com
</code></pre>
<h2 id="生成最终-ca-证书文件-crt">生成最终 CA 证书文件 .crt</h2>
<p>上一步得到的 server.csr 文件必须有CA的签名才可形成证书.</p>
<p>这时，可以提交到权威的CA签名机构(赛门铁克什么的)认证，生成ssl证书
因为我们这里是内部使用，所以<strong>用自签名</strong></p>
<p>使用私钥对证书申请进行签名从而生成证书</p>
<pre><code class="language-shell"># -in   申请签名文件 .csr
# -signkey  私钥 .key
# - out 最终得到的证书文件  .crt
# 证书过期时间选项 &quot;-days 365&quot;.
openssl x509 -req -in server.csr -out server.crt -signkey server.key -days 3650
</code></pre>
<h2 id="放到-nginx-配置上">放到 nginx 配置上</h2>
<pre><code class="language-shell">listen 443;

ssl on;

# crt
ssl_certificate /www/wwwroot/default/certs/server.crt;  
# .key
ssl_certificate_key /www/wwwroot/default/certs/server.key; 
</code></pre>
<h1 id="腾讯云阿里云的免费-ssl-证书">腾讯云、阿里云的免费 SSL 证书</h1>
<h2 id="申请证书">申请证书</h2>
<p>.well-known 验证文件夹里的 fileauth.txt 访问提示 <code>403 forbidden</code></p>
<p>在 nginx 的虚拟主机配置文件里对这个目录单独添加规则</p>
<pre><code class="language-shell">location ^~ /.well-known/pki-validation/ {
           try_files $uri /dev/null =404;
   }
</code></pre>
<h2 id="上传到服务器并修改配置">上传到服务器并修改配置</h2>
<p>参考
<a href="https://www.qcloud.com/document/product/400/4143">https://www.qcloud.com/document/product/400/4143</a></p>
<p>Nginx 为例</p>
<p>审核通过后，得到一个 zip 压缩包。下载并解压后把里面的<code>.crt</code>和<code>.key</code>文件都上传到服务器上，例如放到 <code>/root</code>目录</p>
<p>然后修改虚拟主机配置文件，重新加载配置</p>
<pre><code class="language-shell"># 第一部分，把原来的 HTTP(80端口) 访问方式全部重定向到 HTTPS(443)
# 删除所有的其他配置信息
server
    {
        listen 80;
        server_name www.domian.com;
        index index.html index.htm index.php default.html default.htm default.php;
        root  /home/wwwroot/www.domian.com;

	#重定向
        rewrite ^(.*) https://$host$1 permanent;

    }


# 这一部分是新添加的内容，启用 SSL
server
    {
        listen 443;

        server_name www.domian.com;

        ssl on;
        ssl_certificate /root/1_www.domain.com_bundle.crt;
        ssl_certificate_key /root/2_www.domain.com.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; 
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;
        
        index index.html index.htm index.php default.html default.htm default.php;
        root  /home/wwwroot/www.domain.com;

        include none.conf;
        #error_page   404   /404.html;

        location ^~ /.well-known/pki-validation/ {
                try_files $uri /dev/null =404;
        }
        
        location / {
                if (!-e $request_filename) {
                        rewrite (.*) /index.php;
                }
        }

        include enable-php.conf;

        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
        {
            expires      30d;
        }

        location ~ .*\.(js|css)?$
        {
            expires      12h;
        }

        location ~ /\.
        {
            deny all;
        }

        access_log off;
    }
</code></pre>
<p>关于 域名未通过CA安全审核</p>
<blockquote>
<p>该域名未通过CA安全审核，无法申请Symantec DV证书。请尝试使用其他域名/子域名，或升级其他产品类型。</p>
</blockquote>
<p>可能是因为之前网站被列入恶意名单。。。无法通过Symantec认证，使用 Let&rsquo;s Encrypt 等服务</p>
<h1 id="lets-encrypt">Let&rsquo;s Encrypt</h1>
<h2 id="手动部署-放弃">手动部署 (放弃)</h2>
<p>首先做好域名解析到服务器的操作，能访问服务器（否则后面在自动上传文件时会提示 DNS 错误）</p>
<p><a href="https://angeltime.cc/archives/582.html">https://angeltime.cc/archives/582.html</a></p>
<p><a href="http://www.laozuo.org/7742.html">http://www.laozuo.org/7742.html</a></p>
<p>let&rsquo;s encrypt证书的官网https://letsencrypt.org/，要申请使用免费的ssl证书需要你对web主机有shell访问的权限(SSH访问)，要是有自己的VPS就可以通过ssh进行访问，但您通过cPanel，Plesk或 WordPress等控制面板完全管理您的网站，那么您很有可能没有shell访问权限，您可以要求您的托管服务提供商确定。如果不熟悉vps操作，那么申请过程可能遇到这样那样的问题，现在有一种更为便捷的方法，通过在网页上可视化的申请，网站使用的是let&rsquo;s encrypt的接口，申请的到的就是let&rsquo;s encrypt的免费证书，还可以后台管理。</p>
<p>访问官网：https://www.sslforfree.com/</p>
<p>进入官网，在输入框中输入ssl证书绑定的域名，域名不支持通配符(如：*.xxx.com)，但是<strong>可以绑定最多100个域名或子域名，域名中间用空格分开</strong>，然后点击Create Free SSL Certificate。注意：右上角有一个登陆选项，点击后可以登录或注册，强烈建议注册一个账号并登录，这样申请完证书系统会自动帮你把证书相关信息添加到账户中。</p>
<p>点击创建证书后，这里有三种验证域名所有权的方法，验证成功才可以下载证书。</p>
<p><img src="/media/15490412287446/15203034569862.jpg" alt=""></p>
<p>证书创建成功会有这样的页面，点击页面中的下载证书就会下载一个sslforfree.zip的文件，里面包含了private.key(私钥)、certificate.crt(服务端证书)、ca_bundle.crt(根证书和中继证书)三个文件，根据我们网站的使用的面板或服务器面板把文件复制到对应的地方即可完成服务器端SSL的配置。</p>
<p><img src="/media/15490412287446/15203035634514.jpg" alt=""></p>
<p>把两个 crt 文件合并成一个<code>cert_chain.crt</code></p>
<pre><code class="language-shell">cat certificate.crt ca_bundle.crt &gt;&gt; cert_chain.crt
</code></pre>
<p>在 nginx 里使用</p>
<pre><code class="language-shell">ssl_certificate /env/env_my/ssl/new.renqizx.com/cert_chain.crt;
ssl_certificate_key /env/env_my/ssl/new.renqizx.com/private.key;
</code></pre>
<p>重启nginx，如果报错<code>PEM routines:PEM_read_bio:bad end line</code>，是因为合并的时候没有换行，</p>
<blockquote>
<p>&mdash;&ndash;END CERTIFICATE&mdash;&mdash;&mdash;-BEGIN CERTIFICATE&mdash;&ndash;</p>
</blockquote>
<p>编辑这个合并后的文件，改成下面的即可</p>
<blockquote>
<p>&mdash;&ndash;END CERTIFICATE&mdash;&ndash;
&mdash;&ndash;BEGIN CERTIFICATE&mdash;&ndash;</p>
</blockquote>
<p>后台管理
当你注册账号登陆并成功申请到证书时，你的证书就会在你的后台中出现，你可以查看证书的到期时间，对证书可以续订、撤销、删除，管理活动、过期或删除的证书，系统还会在域名证书到期之前邮件通知你，很方便实用。</p>
<h2 id="自动部署lets-encrypt免费ssl证书--自动续期">自动部署Let’s Encrypt免费SSL证书 &amp;&amp; 自动续期</h2>
<p>要求：</p>
<ol>
<li>需要有域名，然后解析到服务器上，它会生成指定域名的证书。(填IP会报错不支持的)</li>
<li>需要在域名指向的服务器上能访问https。(不然会报找不到443端口的错误)</li>
<li>需要linux环境</li>
</ol>
<p>资料：</p>
<p><a href="https://51.ruyo.net/3163.html">https://51.ruyo.net/3163.html</a></p>
<p><a href="https://certbot.eff.org/">https://certbot.eff.org/</a></p>
<p><a href="https://github.com/certbot/certbot">https://github.com/certbot/certbot</a></p>
<h3 id="安装-certbot">安装 certbot</h3>
<pre><code class="language-shell">cd ~
wget https://dl.eff.org/certbot-auto &amp;&amp; chmod a+x certbot-auto
</code></pre>
<p>会安装 python 环境</p>
<h3 id="生成域名证书">生成域名证书</h3>
<p><strong>注意</strong></p>
<p>先停止 nginx 服务（以及其他占用 80 端口的）</p>
<p>开始没注意到，运行后提示</p>
<blockquote>
<p>Problem binding to port 80: Could not bind to IPv4 or IPv6.”</p>
</blockquote>
<p>根据 <a href="https://community.letsencrypt.org/t/problem-binding-to-port-80-with-standalone/50850">https://community.letsencrypt.org/t/problem-binding-to-port-80-with-standalone/50850</a>，首先要把<code>netstat -ln</code>把占用 80 端口的服务停止(Nginx)</p>
<p>下例是生成 somecolor.cc / <a href="http://www.somecolor.cc">www.somecolor.cc</a> / api.somecolor.cc</p>
<pre><code class="language-shell"># 如果你要生成更多域名，直接后面再加 -d xxxxx.xx  即可
./certbot-auto certonly --standalone -d somecolor.cc -d www.somecolor.cc -d api.somecolor.cc
</code></pre>
<p>需要填写邮箱 ，输入邮箱回车。（Enter email address (used for urgent renewal and security notices) (Enter &lsquo;c&rsquo; to cancel):）
同意TOS条款 ，输入 (A)gree 表示同意，回车。
还有一个同意分享邮箱，输入 N 回车。</p>
<p>生成成功，可到目录<code> /etc/letsencrypt/live/</code> 查看我们的证书了！提示</p>
<p>You should make a secure backup of this folder now</p>
<p><strong>如果遇到报错（Ubuntu16.04）</strong></p>
<blockquote>
<p>OSError: Command /opt/eff.org/certbot/venv/bin/python2.7 - setuptools pkg_resources pip wheel failed with error code 2</p>
</blockquote>
<pre><code class="language-shell">sudo apt-get install letsencrypt
</code></pre>
<p>exoprt below</p>
<pre><code class="language-shell">export LC_ALL=&quot;en_US.UTF-8&quot;
export LC_CTYPE=&quot;en_US.UTF-8&quot;
</code></pre>
<p>还是没有作用，按照下篇，删除多余的python virtualenv</p>
<p><a href="https://segmentfault.com/a/1190000010693933">https://segmentfault.com/a/1190000010693933</a></p>
<pre><code class="language-shell">apt-get purge python-virtualenv python3-virtualenv virtualenv
pip install virtualenv
</code></pre>
<p>重新运行命令成功。</p>
<h3 id="申请ssl证书提示was-considered-an-unsafe-domain-by-a-third-party-api-网站不安全">申请ssl证书提示was considered an unsafe domain by a third-party API (网站不安全)</h3>
<p><a href="https://www.iwwenbo.com/was-considered-an-unsafe-domain-by-a-third-party-api/">https://www.iwwenbo.com/was-considered-an-unsafe-domain-by-a-third-party-api/</a></p>
<p><a href="https://developers.google.com/web/fundamentals/security/hacked/request_review">https://developers.google.com/web/fundamentals/security/hacked/request_review</a></p>
<p>刚注册了一个域名，在申请ssl证书时，提示下面的错误：</p>
<blockquote>
<p>[root@133-130-99-249 certbot-0.16.0]# ./certbot-auto certonly &ndash;webroot &ndash;email <a href="mailto:rxwangwb@gmail.com">rxwangwb@gmail.com</a> -w /usr/share/nginx/weiyanzixun -d weiyanzixun.com -d <a href="http://www.weiyanzixun.com">www.weiyanzixun.com</a>
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator webroot, Installer None
Obtaining a new certificate
An unexpected error occurred:
The client lacks sufficient authorization :: Error creating new authz :: &ldquo;weiyanzixun.com&rdquo; was considered an unsafe domain by a third-party API</p>
</blockquote>
<p>出现这个的原因是原来这个域名被别人用的，内容貌似是赌博之类的内容，所有被Google标记为不安全的网页。</p>
<p>可以去这个网址 <a href="https://transparencyreport.google.com/safe-browsing/search?url=http:%2F%2Fwww.weiyanzixun.com%2F">https://transparencyreport.google.com/safe-browsing/search?url=http:%2F%2Fwww.weiyanzixun.com%2F</a> 检查当前网站的状态，如果检查之后显示不安全而且你是网站主的话，可以到这个网址 <a href="https://developers.google.com/webmasters/hacked/docs/request_review">https://developers.google.com/webmasters/hacked/docs/request_review</a> 去重新提交审核请求。不过你提交审核请求之前最好先去这个网址 <a href="https://www.google.com/webmasters/tools/security-issues?hl=zh-CN&amp;siteUrl=http://www.weiyanzixun.com/">https://www.google.com/webmasters/tools/security-issues?hl=zh-CN&amp;siteUrl=http://www.weiyanzixun.com/</a> 验证这个网站是你的，我用了不到一天Google就把我的网站标记为安全了。</p>
<h3 id="nginx-配置证书">nginx 配置证书</h3>
<pre><code class="language-shell">server
    {
        listen 443;
        server_name api.somecolor.cc;
        index index.html index.htm index.php;
        root  /home/wwwroot/api.cnsecer.com/;
        ssl on;
        ssl_certificate /etc/letsencrypt/live/somecolor.cc/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/somecolor.cc/privkey.pem;
        ssl_protocols  TLSv1 TLSv1.1 TLSv1.2; #可不要
        ssl_ciphers   ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA;#可不要
        ssl_prefer_server_ciphers  on; #可不要
        ssl_session_cache    shared:SSL:10m;  #可不要
        ssl_session_timeout  24h; #可不要
        keepalive_timeout 300s; #可不要
 
 
        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
        {
            expires      30d;
        }
 
        location ~ .*\.(js|css)?$
        {
            expires      12h;
        }
 
        location ~ /\.
        {
            deny all;
        }
 
        access_log  /home/wwwlogs/somecolor.cc.log;
    }
</code></pre>
<h3 id="自动续期">自动续期</h3>
<p>证书有效期只有 90 天，需要设置自动更新的功能，帮我们自动更新证书的时效。</p>
<p>将可执行文件 移动一个公共目录。(如果要放到root目录下，只要处理好权限问题也是可以的)</p>
<p>先在命令行模拟证书更新 手动延期。出现<code>Congratulations</code>表示成功</p>
<pre><code class="language-shell">./certbot-auto renew --dry-run
</code></pre>
<p>利用Cron自动延期(注意路径问题)</p>
<pre><code class="language-shell"># 添加计划任务
crontab -e

# 表示每周一半夜2点30分执行renew任务
30 2 * * 1 /root/certbot-auto renew &gt;&gt; /root/letsencrypt-renew.log

# 每月1号执行
0 0 1 * * /root/certbot-auto renew &gt;&gt; /root/letsencrypt-renew.log
</code></pre>
<h2 id="通配符https证书certbot版--需要能修改-dns-记录权限">通配符HTTPS证书(certbot版)  需要能修改 dns 记录权限</h2>
<p><a href="https://www.jianshu.com/p/f75396b61779">https://www.jianshu.com/p/f75396b61779</a></p>
<pre><code class="language-shell"># 下载
wget https://dl.eff.org/certbot-auto

# 设为可执行权限
chmod a+x certbot-auto
</code></pre>
<p>添加dns记录（txt类型）然后</p>
<p>不要心急着按回车，先执行</p>
<pre><code class="language-shell">yum install bind-utils
dig xxxx.xxx.com txt
</code></pre>
<p>确认解析记录是否生效，生效之后再回去按回车确认</p>
<p>继续</p>
<blockquote>
<p>Please deploy a DNS TXT record under the name
_acme-challenge.renqizx.com with the following value:</p>
</blockquote>
<blockquote>
<p>D4o2NQ-Xjtw4LjgEPLssPeIOBlnb-iU8LAGhlsifzqE</p>
</blockquote>
<p>成功</p>
<blockquote>
<p>IMPORTANT NOTES:</p>
<ul>
<li>Congratulations! Your certificate and chain have been saved at:
/etc/letsencrypt/live/renqizx.com/fullchain.pem
Your key file has been saved at:
/etc/letsencrypt/live/renqizx.com/privkey.pem
Your cert will expire on 2019-01-07. To obtain a new or tweaked
version of this certificate in the future, simply run certbot-auto
again. To non-interactively renew <em>all</em> of your certificates, run
&ldquo;certbot-auto renew&rdquo;</li>
<li>If you like Certbot, please consider supporting our work by:</li>
</ul>
</blockquote>
<blockquote>
<p>Donating to ISRG / Let&rsquo;s Encrypt:   <a href="https://letsencrypt.org/donate">https://letsencrypt.org/donate</a>
Donating to EFF:                    <a href="https://eff.org/donate-le">https://eff.org/donate-le</a></p>
</blockquote>
<p>nginx 配置</p>
<pre><code class="language-shell">server {
    server_name xxx.com;
    listen 443 http2 ssl;
    ssl on;
    ssl_certificate /etc/cert/xxx.cn/fullchain.pem;
    ssl_certificate_key /etc/cert/xxx.cn/privkey.pem;
    ssl_trusted_certificate  /etc/cert/xxx.cn/chain.pem;

    location / {
      proxy_pass http://127.0.0.1:6666;
    }
}
</code></pre>
<p>要续期的话，执行certbot-auto renew就可以了</p>
<p>这样的证书无法应用到主域名xxx.com上，如需把主域名也增加到证书的覆盖范围，请在开始申请证书步骤的那个指令把主域名也加上，如下： 需要注意的是，这样的话需要<strong>修改两次解析记录</strong></p>
<pre><code class="language-shell">./certbot-auto -d &quot;*.xxx.com&quot; -d &quot;xxx.com&quot; --manual --preferred-challenges dns-01 certonly --server https://acme-v02.api.letsencrypt.org/directory
</code></pre>
<p>上面那个3个月后过期，又运行一次好像失败了。</p>
<p>运行下面的成功，不过证书文件名变了。。。。 001-&gt;002.。。</p>
<pre><code class="language-shell">./certbot-auto certonly --webroot -w /env/wwwroot/customer_projects/renqizx/wwwroot -d www.renqizx.com
</code></pre>
<h2 id="自动输入密码">自动输入密码</h2>
<p><a href="https://my.oschina.net/u/200646/blog/808341">https://my.oschina.net/u/200646/blog/808341</a></p>
<pre><code class="language-shell">ssl_password_file /path-to-your-passphrase/ssl.pass;
</code></pre>
<p>这个文件里把密码放进去，每行一个</p>
<p>或者（未测试成功）
<a href="https://blog.csdn.net/u012416928/article/details/53318328">https://blog.csdn.net/u012416928/article/details/53318328</a></p>
<p>使用私钥来生成解密后的key来代替，效果是一样的（就跟ssh连接差不多），达到免密码重启的效果：</p>
<h2 id="最新支持-wildcard-通配符">最新支持 wildcard 通配符</h2>
<p><a href="https://www.v2ex.com/t/437793">https://www.v2ex.com/t/437793</a></p>
<p><a href="https://community.letsencrypt.org/t/acme-v2-production-environment-wildcards/55578">https://community.letsencrypt.org/t/acme-v2-production-environment-wildcards/55578</a></p>
<h2 id="docker-运行-nginx-容器目录映射错误导致读不到文件的问题">Docker 运行 nginx 容器，目录映射错误导致读不到文件的问题</h2>
<p>如果在 docker run 命令或者 docker-compose 中设置了如下的映射(容器内用了别的路径) 为了在容器中读取 file</p>
<blockquote>
<p>/etc/letsencrypt/live/域名:/etc/ssl/域名</p>
</blockquote>
<p>会导致启动容器时报错</p>
<blockquote>
<p>[emerg] 1#1: BIO_new_file(&quot;/etc/nginx/ssl/域名/fullchain.pem&rdquo;) failed (SSL: error:02001002:system library:fopen:No such file or directory:fopen('/etc/nginx/ssl/域名/fullchain.pem&rsquo;,&lsquo;r&rsquo;) error:2006D080:BIO routines:BIO_new_file:no such file)</p>
</blockquote>
<p>经过测试，只有在完全匹配宿主机</p>
<p>也就是说容器内的路径必须也是 /etc/letsencrypt/live/域名/文件（和宿主机的路径一样）</p>
<pre><code class="language-shell">ssl_certificate /etc/letsencrypt/live/域名/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/域名/privkey.pem;
</code></pre>
<p>另外，在宿主机自动更新证书后，要重新启动 nginx 容器以便让证书生效（或者把 certbot 放到容器里面去做计划任务？）</p>
<p><strong>发现是看错名字了。。。</strong></p>
<p>archive 里面是 xxxx1.pem  而 live 目录没有带数字1</p>
<h1 id="nginx-自动将-http-重新定向到-https">Nginx 自动将 HTTP 重新定向到 HTTPS</h1>
<pre><code class="language-shell"># return 301 据说性能较好
return 301 https://$host$request_uri/;

# 如果有一些静态资源 不要加斜杠
return 301 https://$host$request_uri;

# $server_name 和 $host 的区别？
return 301 https://$server_name$request_uri/;

# 或者rewrite 的方法
rewrite ^(.*) https://$host$1 permanent;
</code></pre>
<p><strong>注意</strong>
如果你的网站有一些静态文件路径写死在内容中(例如一些以前发的文章)。例如某一篇文章中有这样一个文件让用户下载</p>
<blockquote>
<p><a href="http://www.example.org/uploads/test.pdf">http://www.example.org/uploads/test.pdf</a></p>
</blockquote>
<p>那么上面的 return 301 就不要在最后加斜杠了，否则会报 404 错误。或者添加一个处理过程，首先判断是否是一个文件，如果不是，再添加斜杠。</p>
<pre><code class="language-shell">return 301 https://$host$request_uri;
</code></pre>
<h1 id="nginx-代理服务支持-https">nginx 代理服务支持 https</h1>
<h2 id="直接放到代理的-host-上">直接放到代理的 host 上</h2>
<h2 id="负载均衡">负载均衡</h2>
<p>可以使用<code>upstream [name]</code>，在里面添加一个、多个后端真实服务器地址:端口。然后在下面的<code>server</code>配置<code>proxy_pass</code>里直接引用 upstream 的 [name]</p>
<pre><code class="language-shell"># Load balancing(optional)
upstream www-sample-org {
    server www-sample-org-nginx:443;
    # server localhost:80443;
    # more load balance servers ...
}

# HTTP 80
server {
    listen       80;
    
    # 不需要
    #server_name www.sample.org www2.sample.org;
    
    return 301 https://$host$request_uri;
}

# HTTPS 443
server {
    listen 443 ssl;
    server_name www.sample.org www2.sample.org;;

    # ssl on;
    ssl_certificate /etc/letsencrypt/live/www.sample.org/4534db34df9c1dfa.crt;
    ssl_certificate_key /etc/letsencrypt/live/www.sample.org/www.sample.org.key;
    #ssl_password_file /etc/letsencrypt/live/www.sample.org/ssl.pass;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_set_header host $host;
        proxy_set_header x-real-ip $remote_addr;
        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Forwarded-Proto https;

        proxy_redirect off; # 待测试是否可删除
        proxy_redirect http:// $scheme://;

        # if use upstream, 则使用前面 upstream 后定义的名称 www-sample-org ,使用负载均衡里面的服务器列表
        #proxy_pass https://www-sample-org;
        
        # if not use upstream, 直接使用 hostname:端口
        proxy_pass https://www-sample-org-nginx:443;
        #proxy_pass https://localhost:80443;
    }
    #access_log /var/log/nginx/nginx_access.log;
}
</code></pre>
<p>为了<strong>简化后端的配置信息</strong>， 在后端直接用 80 端口普通 http 协议即可，不需要在重复写 ssl 证书相关的信息。</p>
<p>然后<code>proxy_pass http://localhost:8080;</code> 在代理配置里把 http/https 全部转发到后端的 http 协议。</p>
<p>但是这个会造成 laravel 的登录失败。。  看来还是得在前后端都配置 https 信息</p>
<h2 id="然后定义后端服务-nginx-的主机配置">然后定义后端服务 nginx 的主机配置</h2>
<p>对应上面的 <code>www-sample-org-nginx:443</code> 或 <code>localhost:80443</code></p>
<p>主要是 root 目录地址，还有处理 php 、静态文件等</p>
<pre><code class="language-shell">#server {
#    listen       80;
#    server_name www.sample.org www2.sample.org;
#    return 301 https://$host$request_uri;
#}

server {
    listen       443 ssl;
    server_name www.sample.org www2.sample.org;
    
    ssl on;
    ssl_certificate /etc/letsencrypt/live/www.sample.org/4534db34df9c1dfa.crt;
    ssl_certificate_key /etc/letsencrypt/live/www.sample.org/www.sample.org.key;
   
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;

    index index.php index.html;
    root /var/www/html/www.sample.org/public;
    
    location ~ .*\.(php|php5)?$ {
        try_files $uri =404;
        fastcgi_pass   localhost:9000; 
        fastcgi_index index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    #access_log  /home/wwwlogs/nginx_access.log www_log_format;
}

</code></pre>
<h1 id="wordpress-等启用-ssl-后原来的静态资源文件或者外部的-http-文件链接无法访问导致出现不安全提示">wordpress 等启用 SSL 后，原来的静态资源文件(或者外部的 http 文件链接)无法访问导致出现“不安全”提示</h1>
<p>“混合内容”</p>
<p>HTTPS 的域名下，如果加载了非 HTTPS 的资源，会提示错误，并且文件被 block</p>
<p>进入 WP 后台的通用设置，修改 URL 为以 HTTPS 开头。</p>
<p>或者安装插件 WordPress HTTPS (SSL)  really-simple-ssl</p>
<p>参考
<a href="https://managewp.com/wordpress-ssl-settings-and-how-to-resolve-mixed-content-warnings">https://managewp.com/wordpress-ssl-settings-and-how-to-resolve-mixed-content-warnings</a></p>
<p>或者同时支持 HTTP 和 HTTPS</p>
<p>这个办法可以自动把页面里的旧 http 资源改成 https 协议。</p>
<p>但是如果https访问文件不存在，那么就会报404 （七牛免费额度只支持 http）</p>
<p>如果要<strong>启用mixed content</strong>，允许在 https 网页里加载 http 的资源，则用下面的办法 （默认不允许加载http与https混合内容）</p>
<h2 id="粗暴关闭在加载不安全-http-静态资源的提示">粗暴：关闭在加载不安全 HTTP 静态资源的提示</h2>
<p>可以在相应的页面的<!-- raw HTML omitted -->里加上这句代码，意思是自动将http的不安全请求升级为https</p>
<pre><code class="language-html">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;upgrade-insecure-requests&quot;&gt;
</code></pre>
<p>详情可以参考这里：http://thehackernews.com/2015/04/disable-mixed-content-warning.html
和这里
<a href="http://www.fly63.com/article/detial/583">http://www.fly63.com/article/detial/583</a></p>
<h1 id="如果是从-godaddy-上生成的得到两个-crt-文件">如果是从 GoDaddy 上生成的，得到两个 crt 文件？</h1>
<p>GoDaddy上没有直接下载 Nginx 的证书选项，只有个“Other”</p>
<p>下载后，把这两个合并成一个文件，再按前面的步骤就可以了</p>
<pre><code class="language-shell"># 一个是随机字符和数字的名称，一个是带 bundle 的名
cat example.com.crt intermediate.crt &gt; example.com.chained.crt
</code></pre>
<h1 id="godaddy-虚拟主机绑定-ssl-与续期">Godaddy 虚拟主机绑定 SSL 与续期</h1>
<p>访问网站提示</p>
<p><img src="/media/15490412287446/15329141600475.jpg" alt="">
查看详情</p>
<p><img src="/media/15490412287446/15329141264446.jpg" alt=""></p>
<h2 id="申请并下载-ssl-证书">申请并下载 SSL 证书</h2>
<p>在账号管理里，购买一个付费的 SSL ，或者申请一个免费的 SSL 证书</p>
<p>然后，进入“管理”界面。</p>
<p>可以<strong>下载</strong>或者更新。</p>
<p>在选择平台的时候，如果是用于在 GoDaddy 自带的虚拟主机，下载 Apache 版本（就是等下在 CPanel 里用的）
如果是用于你自己服务器，可能就要下载 Nginx 等版本了。</p>
<h2 id="虚拟主机可以通过-cpanel-面板管理绑定这个-ssl-证书">虚拟主机（可以通过 CPanel 面板管理）绑定这个 SSL 证书</h2>
<p>打开 CPanel, 拉到下面，找到 SSL 选项，点进去找到“Install And &hellip;”</p>
<p>Click the link below title “Manage SSL sites”</p>
<p><img src="/media/15490412287446/%E6%89%BE%E5%88%B0%E6%9C%80%E4%B8%8B%E9%9D%A2%E6%B7%BB%E5%8A%A0%E6%88%96%E7%AE%A1%E7%90%86SSL.jpg" alt="找到最下面添加或管理SS">
Now you can see all the SSL certification files in the list.</p>
<p>Today is 7/28/18, so the Expiration(UTC)  7/26/18 means this SSL file is expired. we need to renew a new file.</p>
<p><img src="/media/15490412287446/15329143154979.jpg" alt=""></p>
<p>Click the &ldquo;Edit&rdquo; to manage SSL files of this domain list.
then you can update Cetifcatin by choosing a locate file(which downloaded in previous step, the Apache version)</p>
<p>upload the &ldquo;.crt&rdquo; file that the filename contains some letters and number. like a32adf23sdf.crt</p>
<p><img src="/media/15490412287446/15329144687891.jpg" alt=""></p>
<p>display the contents of this .crt file</p>
<p><img src="/media/15490412287446/15329146363917.jpg" alt=""></p>
<p>remove the old SSL file which has been expired.</p>
<p>Congratulations! now the SSL file works.</p>
<p><img src="/media/15490412287446/15329146824252.jpg" alt=""></p>
<h1 id="在本地开发环境不想在重启-nginx-时输入-pem-密码">在本地开发环境，不想在重启 nginx 时输入 PEM 密码</h1>
<p>配置好的 Nginx 每次启动都要输入PEM pass phrase，这是因为在设置私钥key时将密码设置写入了key文件，导致Nginx/Apache等系列服务器在启动时要求Enter PEM pass phrase。</p>
<p>这在生产环境上没什么问题，毕竟不会老是去重启 nginx，而开发环境由于经常要调整 nginx 的配置就很麻烦了。</p>
<p>我们需要做的是剥离这个密码，利用如下OpenSSL命令生成server.key.unsecure文件：</p>
<pre><code class="language-shell">openssl rsa -in server.key -out server.key.unsecure
</code></pre>
<p>然后修改 vhost 配置</p>
<pre><code class="language-shell">server {
  listen 443;
  server_name www.example.com;
  root /home/www;
  ssl on;
  ssl_certificate /etc/nginx/certs/server.crt;
  # 修改下面这一行指向我们生成的server.key.unsecure文件
  ssl_certificate_key /etc/nginx/certs/server.key.unsecure;
}
</code></pre>
<p>重启Nginx，不会再出现了</p>
<h1 id="本地开发环境的虚假域名启用-ssl">本地开发环境的虚假域名启用 SSL</h1>
<p>一些本地开发环境中，hosts 文件指向 127.0.0.1 到一些虚假的本地测试域名，也需要启用 SSL (自签名)</p>
<p>使用OpenSSL创建一个自签名密钥和证书对</p>
<p>nginx-selfsigned.key 私钥文件，必须保密
nginx-selfsigned.crt  证书</p>
<pre><code class="language-shell">mkdir /etc/ssl
cd /etc/ssl

sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout nginx-selfsigned.key -out nginx-selfsigned.crt
</code></pre>
<p>其他信息都不要填，域名可以填通配符的 <code>*.example.org</code> 这样可以用于多个本地测试域名</p>
<p>然后建立一个强大的Diffie-Hellman组，确保通信的保密，生成时间可能需要几分钟</p>
<pre><code class="language-shell">sudo openssl dhparam -out dhparam.pem 2048
</code></pre>
<p>然后修改 nginx 中 vhosts 的配置，格式如下</p>
<pre><code class="language-shell">server {
    listen 443 http2 ssl;
    listen [::]:443 http2 ssl;

    server_name server_IP_address;

    ssl_certificate /etc/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/ssl/nginx-selfsigned.key;
    ssl_dhparam /etc/ssl/dhparam.pem;
}
</code></pre>
<p>还有一些<strong>额外的选项</strong>用于提高 SSL 的安全性，补充在前面的配置信息后面即可</p>
<pre><code class="language-shell">########################################################################
    # from https://cipherli.st/                                            #
    # and https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html #
    ########################################################################

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ciphers &quot;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&quot;;
    ssl_ecdh_curve secp384r1;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    # Disable preloading HSTS for now.  You can use the commented out header line that includes
    # the &quot;preload&quot; directive if you understand the implications.
    #add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;;
    add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains&quot;;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;

    ##################################
    # END https://cipherli.st/ BLOCK #
    ##################################
</code></pre>
<p>因为是自己创建的证书，所以默认浏览器是不信任的，在浏览器打开时会提示一个错误。</p>
<p>打开“查看证书”，拖动证书图标到某个地方，生成一个 <code>.cer</code>文件，双击导入，然后设置为“总是信任”</p>
<h2 id="另外一个资料">另外一个资料</h2>
<p>假设保存路径是<code>/usr/local/nginx/ssl/</code></p>
<p>在这个目录下执行</p>
<pre><code class="language-shell">openssl genrsa -des3 -out server.key 1024 //创建自身密钥 本地的虚拟机环境,1024够了

openssl req -new -key server.key -out server.csr //通过密钥生成相应CSR申请文件 正规要钱的就要拿着这玩意去申请了,同时里面的内容还要认真填,本地测试的就算了,随便吧 

openssl rsa -in server.key -out server.key //生成浏览器浏览网页时不需要输入密码的密钥 重写server.key,网上有人怕操作失误会重命名,看个人喜好了 

openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt//生成证书
</code></pre>
<p>nginx 配置</p>
<pre><code class="language-shell">listen 80;
listen 443 ssl;
server_name *******;

#charset koi8-r;
#access_log logs/host.access.log main;

ssl_certificate /usr/local/nginx/ssl/server.crt;
ssl_certificate_key /usr/local/nginx/ssl/server.key;

location / {
	root /usr/local/nginx/html/*******;
	index index.html index.htm index.php;
}
</code></pre>
<p>接下来就不用说了,重启nginx,然后访问,O了</p>
<h1 id="参考资料">参考资料</h1>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-16-04</a></p>
<p>Godaddy setup ssl 详细
<a href="https://www.youtube.com/watch?v=cpq1qjPkBlo">https://www.youtube.com/watch?v=cpq1qjPkBlo</a></p>
<h1 id="其他">其他</h1>
<h2 id="转换-cer-格式到-pem">转换 cer 格式到 pem</h2>
<pre><code class="language-shell">openssl x509 -inform der -in certificate.cer -out certificate.pem
</code></pre>
    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接: </strong>
      <a href="https://my101du.github.io/1/01/%E4%B8%BA%E7%AB%99%E7%82%B9%E5%90%AF%E7%94%A8https/" title="" target="_blank" rel="external">https://my101du.github.io/1/01/%E4%B8%BA%E7%AB%99%E7%82%B9%E5%90%AF%E7%94%A8https/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License：</strong><a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/my101du" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://avatars2.githubusercontent.com/u/1332645?s=460&amp;u=dc114d6baad010456a5af87c4cc2df0694ff2b1c&amp;v=4" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/my101du" target="_blank"><span class="text-dark">my101du</span><small class="ml-1x"></small></a></h3>
        <div>Stay Hungry, Stay Foolish</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>
<section id="comments">
</section>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://my101du.github.io/1/01/%E4%BD%BF%E7%94%A8linux-nginxapache-mysql-php%E6%90%AD%E5%BB%BA%E7%BD%91%E7%AB%99/" title=""><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;下一篇</span></a>
            </li>
            <li class="next">
                <a href="https://my101du.github.io/1/01/windows-bat%E6%89%B9%E5%A4%84%E7%90%86/"
                    title=""><span>上一篇&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="文章目录" role="button">
                    <span>[&nbsp;</span><span>文章目录</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/my101du" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://my101du.github.io/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2017  -
    2020
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/php.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://my101du.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://my101du.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(未命名)',
            },
            ROOT_URL: 'https:\/\/my101du.github.io\/',
            CONTENT_URL: 'https:\/\/my101du.github.io\/\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://my101du.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
